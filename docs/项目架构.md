# é¡¹ç›®æ¶æ„æ–‡æ¡£

## ğŸ“ é¡¹ç›®ç»“æ„

```
app/src/main/java/com/fam4k007/videoplayer/
â”œâ”€â”€ VideoPlayerActivity.kt          # æ’­æ”¾å™¨ä¸»ç•Œé¢
â”œâ”€â”€ VideoBrowserActivity.kt         # æ–‡ä»¶å¤¹æµè§ˆ
â”œâ”€â”€ VideoListActivity.kt            # è§†é¢‘åˆ—è¡¨
â”œâ”€â”€ MainActivity.kt                 # åº”ç”¨é¦–é¡µ
â”œâ”€â”€ player/                         # æ’­æ”¾å™¨æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ PlaybackEngine.kt          # æ’­æ”¾å¼•æ“ (MPVå°è£…)
â”‚   â”œâ”€â”€ PlayerControlsManager.kt   # æ’­æ”¾æ§åˆ¶UIç®¡ç†
â”‚   â”œâ”€â”€ PlayerDialogManager.kt     # å¯¹è¯æ¡†ç®¡ç†
â”‚   â”œâ”€â”€ GestureHandler.kt          # æ‰‹åŠ¿å¤„ç†
â”‚   â”œâ”€â”€ SeriesManager.kt           # ç³»åˆ—è§†é¢‘ç®¡ç†
â”‚   â””â”€â”€ CustomMPVView.kt           # MPVè§†å›¾å°è£…
â”œâ”€â”€ manager/                        # ä¸šåŠ¡ç®¡ç†å™¨
â”‚   â”œâ”€â”€ PreferencesManager.kt      # è®¾ç½®ç®¡ç†
â”‚   â””â”€â”€ SubtitleManager.kt         # å­—å¹•ç®¡ç†
â”œâ”€â”€ danmaku/                        # å¼¹å¹•æ¨¡å—
â”‚   â”œâ”€â”€ DanmakuManager.kt          # å¼¹å¹•ç®¡ç†å™¨
â”‚   â”œâ”€â”€ DanmakuConfig.kt           # å¼¹å¹•é…ç½®
â”‚   â””â”€â”€ DanmakuPlayerView.kt       # å¼¹å¹•è§†å›¾
â”œâ”€â”€ utils/                          # å·¥å…·ç±»
â”‚   â”œâ”€â”€ VideoScanner.kt            # è§†é¢‘æ‰«æ
â”‚   â”œâ”€â”€ ThumbnailCacheManager.kt   # ç¼©ç•¥å›¾ç¼“å­˜
â”‚   â”œâ”€â”€ ThemeManager.kt            # ä¸»é¢˜ç®¡ç†
â”‚   â””â”€â”€ DialogUtils.kt             # å¯¹è¯æ¡†å·¥å…·
â”œâ”€â”€ database/                       # æ•°æ®åº“
â”‚   â”œâ”€â”€ VideoDatabase.kt           # Roomæ•°æ®åº“
â”‚   â””â”€â”€ VideoCacheDao.kt           # è§†é¢‘ç¼“å­˜DAO
â”œâ”€â”€ adapter/                        # é€‚é…å™¨
â”œâ”€â”€ Anime4KManager.kt              # Anime4Kè¶…åˆ†ç®¡ç†
â””â”€â”€ PlaybackHistoryManager.kt      # æ’­æ”¾å†å²ç®¡ç†
```

## ğŸ¯ æ ¸å¿ƒç®¡ç†å™¨èŒè´£

### æ’­æ”¾å™¨æ ¸å¿ƒ (player/)

| ç®¡ç†å™¨ | èŒè´£ | ä¿®æ”¹ä½ç½® |
|--------|------|---------|
| **PlaybackEngine** | MPVæ’­æ”¾æ§åˆ¶ã€å±æ€§ç®¡ç†ã€äº‹ä»¶å›è°ƒ | æ’­æ”¾/æš‚åœ/å¿«è¿›/éŸ³é‡/å­—å¹•è½¨é“ |
| **PlayerControlsManager** | UIæ§ä»¶æ˜¾ç¤º/éšè—ã€è¿›åº¦æ¡ã€æŒ‰é’®äº‹ä»¶ | æ’­æ”¾ç•Œé¢UIäº¤äº’ |
| **PlayerDialogManager** | æ‰€æœ‰å¯¹è¯æ¡†ç®¡ç† (å­—å¹•/éŸ³è½¨/å¼¹å¹•/é€Ÿåº¦ç­‰) | å¯¹è¯æ¡†æ˜¾ç¤ºä¸äº¤äº’ |
| **GestureHandler** | å±å¹•æ‰‹åŠ¿å¤„ç† (æ»‘åŠ¨è°ƒèŠ‚éŸ³é‡/äº®åº¦/è¿›åº¦) | æ‰‹åŠ¿æ§åˆ¶é€»è¾‘ |
| **SeriesManager** | ç³»åˆ—è§†é¢‘è¯†åˆ«ã€ä¸Šä¸€é›†/ä¸‹ä¸€é›†åˆ‡æ¢ | è¿ç»­æ’­æ”¾åŠŸèƒ½ |

### ä¸šåŠ¡ç®¡ç†å™¨ (manager/)

| ç®¡ç†å™¨ | èŒè´£ | ä¿®æ”¹ä½ç½® |
|--------|------|---------|
| **PreferencesManager** | SharedPreferenceså°è£…ã€è®¾ç½®è¯»å†™ | ç”¨æˆ·è®¾ç½®å­˜å‚¨ |
| **SubtitleManager** | å¤–æŒ‚å­—å¹•åŠ è½½ã€MPVå­—å¹•å‘½ä»¤å°è£… | å­—å¹•å¯¼å…¥åŠŸèƒ½ |

### å¼¹å¹•ç³»ç»Ÿ (danmaku/)

| ç»„ä»¶ | èŒè´£ | ä¿®æ”¹ä½ç½® |
|------|------|---------|
| **DanmakuManager** | å¼¹å¹•åŠ è½½ã€æ’­æ”¾æ§åˆ¶ã€æ ·å¼ç®¡ç† | å¼¹å¹•åŠŸèƒ½ |
| **DanmakuConfig** | å¼¹å¹•å…¨å±€é…ç½® (å¤§å°/é€Ÿåº¦/é€æ˜åº¦ç­‰) | å¼¹å¹•è®¾ç½® |
| **DanmakuPlayerView** | å¼¹å¹•æ¸²æŸ“è§†å›¾ (åŸºäºDanmakuFlameMaster) | å¼¹å¹•æ˜¾ç¤º |

### å…¶ä»–é‡è¦ç»„ä»¶

| ç»„ä»¶ | èŒè´£ | ä¿®æ”¹ä½ç½® |
|------|------|---------|
| **Anime4KManager** | Anime4Kç€è‰²å™¨ç®¡ç†ã€æ¨¡å¼åˆ‡æ¢ | è¶…åˆ†åŠŸèƒ½ |
| **PlaybackHistoryManager** | æ’­æ”¾å†å²è®°å½• (è¿›åº¦/å¼¹å¹•çŠ¶æ€ç­‰) | å†å²è®°å½• |
| **VideoScanner** | MediaStoreè§†é¢‘æ‰«æã€å¼‚æ­¥åŠ è½½ | è§†é¢‘æ‰«æ |
| **ThumbnailCacheManager** | è§†é¢‘ç¼©ç•¥å›¾æå–ä¸ç¼“å­˜ | ç¼©ç•¥å›¾åŠŸèƒ½ |

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹

### è§†é¢‘æ’­æ”¾æµç¨‹
```
VideoPlayerActivity
    â†“
åˆå§‹åŒ– PlaybackEngine (MPV)
    â†“
åˆå§‹åŒ– DanmakuManager
    â†“
åˆå§‹åŒ– PlayerControlsManager (UI)
    â†“
åˆå§‹åŒ– GestureHandler (æ‰‹åŠ¿)
    â†“
PlaybackEngine åŠ è½½è§†é¢‘
    â†“ (äº‹ä»¶å›è°ƒ)
æ›´æ–° UI / åŒæ­¥å¼¹å¹•
```

### å¯¹è¯æ¡†äº¤äº’æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’® (PlayerControlsManager)
    â†“
è§¦å‘å›è°ƒ (VideoPlayerActivity)
    â†“
è°ƒç”¨ PlayerDialogManager
    â†“
æ˜¾ç¤ºå¯¹è¯æ¡† + å¤„ç†ç”¨æˆ·æ“ä½œ
    â†“
è°ƒç”¨ç›¸åº”ç®¡ç†å™¨æ‰§è¡Œæ“ä½œ
```

## ğŸ› Bugä¿®å¤æŒ‡å—

### æ’­æ”¾é—®é¢˜
- **ä½ç½®**: `PlaybackEngine.kt` - MPVå‘½ä»¤å’Œå±æ€§ç®¡ç†
- **æ£€æŸ¥**: MPVLibè°ƒç”¨ã€äº‹ä»¶ç›‘å¬ã€å±æ€§è¯»å†™

### UIé—®é¢˜
- **ä½ç½®**: `PlayerControlsManager.kt` - æ§ä»¶æ˜¾ç¤ºé€»è¾‘
- **æ£€æŸ¥**: Viewå¼•ç”¨ã€ç‚¹å‡»äº‹ä»¶ã€è‡ªåŠ¨éšè—é€»è¾‘

### å¼¹å¹•é—®é¢˜
- **ä½ç½®**: `DanmakuManager.kt` + `DanmakuPlayerView.kt`
- **æ£€æŸ¥**: å¼¹å¹•åŠ è½½ã€æ—¶é—´åŒæ­¥ã€æ ·å¼åº”ç”¨

### å­—å¹•é—®é¢˜
- **ä½ç½®**: `SubtitleManager.kt` + `PlaybackEngine.kt`
- **æ£€æŸ¥**: æ–‡ä»¶è·¯å¾„ã€MPV sub-addå‘½ä»¤ã€è½¨é“åˆ‡æ¢

### æ‰‹åŠ¿é—®é¢˜
- **ä½ç½®**: `GestureHandler.kt`
- **æ£€æŸ¥**: GestureDetectorå›è°ƒã€éŸ³é‡/äº®åº¦è°ƒèŠ‚é€»è¾‘

### è¶…åˆ†é—®é¢˜
- **ä½ç½®**: `Anime4KManager.kt` + `PlaybackEngine.kt`
- **æ£€æŸ¥**: ç€è‰²å™¨æ–‡ä»¶è·¯å¾„ã€glsl-shaderså±æ€§è®¾ç½®

### è®¾ç½®é—®é¢˜
- **ä½ç½®**: `PreferencesManager.kt`
- **æ£€æŸ¥**: SharedPreferencesé”®åã€é»˜è®¤å€¼

## ğŸ“ ä»£ç è§„èŒƒ

### å†…å­˜ç®¡ç†
- æ‰€æœ‰Managerä½¿ç”¨ `WeakReference<Activity>` é˜²æ­¢å†…å­˜æ³„æ¼
- Dialogéœ€æ·»åŠ åˆ° `activeDialogs` åˆ—è¡¨ç»Ÿä¸€ç®¡ç†
- Activityé”€æ¯æ—¶è°ƒç”¨æ‰€æœ‰Managerçš„ `cleanup()` æ–¹æ³•

### å¼‚æ­¥æ“ä½œ
- ä½¿ç”¨ `lifecycleScope` å¯åŠ¨åç¨‹ (ç»‘å®šç”Ÿå‘½å‘¨æœŸ)
- IOæ“ä½œä½¿ç”¨ `Dispatchers.IO`
- UIæ›´æ–°ä½¿ç”¨ `Dispatchers.Main`

### ViewBinding
- å·²è¿ç§»: VideoBrowserActivity, VideoListActivity, MainActivity
- æœªè¿ç§»: VideoPlayerActivity (ä¿æŒfindViewByIdé¿å…å¤§è§„æ¨¡é‡æ„)

## ğŸ”§ å¸¸ç”¨ä¿®æ”¹åœºæ™¯

| éœ€æ±‚ | ä¿®æ”¹æ–‡ä»¶ |
|------|---------|
| æ·»åŠ æ’­æ”¾æ§åˆ¶æŒ‰é’® | PlayerControlsManager.kt + layout XML |
| ä¿®æ”¹æ‰‹åŠ¿çµæ•åº¦ | GestureHandler.kt (å¸¸é‡è°ƒæ•´) |
| æ·»åŠ å¯¹è¯æ¡†é€‰é¡¹ | PlayerDialogManager.kt |
| ä¿®æ”¹å¼¹å¹•æ ·å¼ | DanmakuConfig.kt + PreferencesManager.kt |
| æ·»åŠ MPVå±æ€§ | PlaybackEngine.kt |
| ä¿®æ”¹æ‰«æé€»è¾‘ | VideoScanner.kt |
| æ·»åŠ ç”¨æˆ·è®¾ç½® | PreferencesManager.kt |

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-08  
**å½“å‰ç‰ˆæœ¬**: ç¬¬ä¸€é˜¶æ®µä¼˜åŒ–å®Œæˆ (ç¼–è¯‘æˆåŠŸ)
