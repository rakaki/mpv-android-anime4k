# 哔哩哔哩登录实现说明

## 简介

本应用使用**二维码扫码登录**的方式实现B站账号登录，这是一种安全、便捷的登录方式，不需要用户输入账号密码。

## 登录流程

### 1. 获取二维码

当用户点击"登录"按钮后，应用会做以下操作：

```
1. 向B站服务器申请一个登录二维码
   请求地址: https://passport.bilibili.com/x/passport-login/web/qrcode/generate
   
2. B站返回两个重要信息：
   - 二维码链接（url）: 用于生成二维码图片
   - 二维码密钥（qrcode_key）: 用于后续查询登录状态
```

### 2. 显示二维码

```
1. 应用使用 ZXing 库将二维码链接转换为二维码图片
2. 在屏幕上显示二维码供用户扫描
```

### 3. 扫码过程

用户使用**哔哩哔哩手机客户端**的扫码功能扫描二维码：

```
状态变化：
等待扫码 → 已扫码，等待确认 → 登录成功
```

**重要提示**：
- 扫描后不要立即点确认！
- 等待应用界面显示"已扫码"状态后，再在手机上点击确认
- 点击确认后请耐心等待，应用会自动返回

### 4. 轮询登录状态

在显示二维码期间，应用会每隔一段时间（通常3秒）向B站服务器查询登录状态：

```
查询地址: https://passport.bilibili.com/x/passport-login/web/qrcode/poll
参数: qrcode_key（二维码密钥）

可能的状态：
- 86101: 未扫码（继续等待）
- 86090: 已扫码未确认（提示用户确认）
- 0: 登录成功（保存凭证）
- 86038: 二维码已过期（需要刷新）
```

### 5. 保存登录信息

当登录成功后，B站会返回以下重要信息：

```
返回数据包含：
- Cookie信息（包含多个认证字段）
- 用户基本信息（用户名、UID等）

应用会做以下处理：
1. 提取关键Cookie字段（SESSDATA、bili_jct、DedeUserID等）
2. 使用AES-256加密算法加密这些敏感信息
3. 加密后保存到本地SharedPreferences
4. 显示登录成功信息
5. 自动返回上一页面
```

## 技术要点

### 二维码生成

```kotlin
// 使用Google的ZXing库生成二维码
val qrCodeWriter = QRCodeWriter()
val bitMatrix = qrCodeWriter.encode(
    url,              // B站返回的二维码链接
    BarcodeFormat.QR_CODE,
    size,             // 二维码大小（像素）
    size
)
// 将bitMatrix转换为Bitmap图片显示
```

### 状态轮询

```kotlin
// 使用Kotlin协程每3秒查询一次
while (isActive) {
    val result = authManager.pollQRCodeStatus(qrcodeKey)
    when (result.code) {
        0 -> {
            // 登录成功，停止轮询
            break
        }
        86101 -> {
            // 未扫码，继续等待
        }
        86090 -> {
            // 已扫码，提示用户确认
        }
        86038 -> {
            // 二维码过期，提示刷新
            break
        }
    }
    delay(3000) // 等待3秒后再次查询
}
```

### 数据加密存储

登录凭证使用AES-256加密后存储，具体安全措施详见 [安全说明文档](bilibili_security_analysis.md)。

## 为什么使用扫码登录？

1. **安全性高**：
   - 不需要在应用中输入账号密码
   - 避免密码被第三方应用获取的风险
   - 由B站官方客户端完成认证过程

2. **便捷性好**：
   - 手机扫一扫即可完成登录
   - 无需记住复杂密码
   - 登录状态可长期保持

3. **官方支持**：
   - 这是B站官方提供的公开登录方式
   - 网页版B站也使用相同的登录方式
   - 稳定可靠，不易失效

## 常见问题

### Q: 为什么扫码后要等一会儿才能点确认？

A: 应用需要通过轮询来获取"已扫码"状态。如果立即点确认，应用可能还没来得及查询到这个状态，会导致用户体验不佳。等待几秒钟，让应用检测到状态变化后再确认，能确保流程顺畅。

### Q: 登录信息会过期吗？

A: 会的。B站的登录凭证有效期通常为一个月左右。过期后需要重新扫码登录。应用会在使用凭证时自动检查是否过期。

### Q: 登录信息安全吗？

A: 是的。所有登录凭证都经过AES-256加密存储在本地，密钥使用设备唯一标识生成，详见 [安全说明文档](bilibili_security_analysis.md)。

### Q: 登录后能做什么？

A: 登录后可以：
- 观看需要登录才能看的番剧（如会员专享内容）
- 获取更高的视频画质（1080P+）
- 使用其他需要登录的功能

## 相关文档

- [番剧解析原理](bilibili_bangumi.md) - 了解如何解析和播放B站番剧
- [安全说明](bilibili_security_analysis.md) - 了解登录信息的安全保护措施
